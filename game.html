<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Action: Drive & Shoot</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* כוונת לרובה */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            background: transparent; border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: red; transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* ממשק */
        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
        #instructions {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            color: #FFD700; font-size: 18px; text-align: center;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px;
        }
        #health-bar {
            position: absolute; bottom: 20px; left: 20px; width: 200px; height: 20px;
            background: #333; border: 2px solid white;
        }
        #health-fill { width: 100%; height: 100%; background: lime; transition: width 0.2s; }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    <div id="ui">
        <div>Score: <span id="score">0</span></div>
        <div>Enemies: <span id="enemy-count">0</span></div>
    </div>
    <div id="health-bar"><div id="health-fill"></div></div>
    <div id="instructions">
        CLICK to Start/Lock Mouse<br>
        WASD = Move | E = Enter/Exit Car | CLICK = Shoot
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import * as CANNON from 'cannon-es';

        // --- משתנים גלובליים ---
        let scene, camera, renderer, world;
        let controls; // שליטת שחקן
        let raycaster; // ליריות
        
        // משחקיות
        let gameState = 'WALKING'; // WALKING | DRIVING
        let playerBody; // הגוף הפיזי של השחקן
        let lastShot = 0;
        let score = 0;
        let playerHealth = 100;

        // רכב
        let vehicle, chassisBody;
        let wheelMeshes = [];
        let carMesh;

        // אויבים
        let enemies = [];
        const enemySpeed = 3;

        // קלטים
        const keys = { w:false, a:false, s:false, d:false, space:false };

        init();
        animate();

        function init() {
            // 1. הגדרת עולם תלת מימד
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x202020);
            scene.fog = new THREE.Fog(0x202020, 10, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 2. פיזיקה
            world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) });
            const groundMat = new CANNON.Material();
            const wheelMat = new CANNON.Material();
            const contactMat = new CANNON.ContactMaterial(wheelMat, groundMat, { friction: 0.3, restitution: 0 });
            world.addContactMaterial(contactMat);

            // 3. תאורה
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 50, 50);
            sun.castShadow = true;
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x404040));

            // 4. יצירת סביבה
            createGround(groundMat);
            createRamps(groundMat);
            
            // 5. יצירת שחקן
            createPlayer();
            controls = new PointerLockControls(camera, document.body);
            document.addEventListener('click', () => controls.lock());
            
            // 6. יצירת רכב
            createCar(wheelMat);

            // 7. יצירת אויבים ראשונים
            spawnEnemy(); spawnEnemy(); spawnEnemy();

            // יריות
            raycaster = new THREE.Raycaster();

            // האזנה למקלדת
            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));
            document.addEventListener('mousedown', onShoot);
            
            window.addEventListener('resize', onWindowResize);
        }

        function createGround(mat) {
            // רצפה ויזואלית
            const geo = new THREE.PlaneGeometry(200, 200);
            const tex = new THREE.TextureLoader().load('https://threejs.org/examples/textures/grid.png');
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(40, 40);
            const mesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ map: tex }));
            mesh.rotation.x = -Math.PI / 2;
            mesh.receiveShadow = true;
            scene.add(mesh);

            // רצפה פיזיקלית
            const body = new CANNON.Body({ mass: 0, material: mat });
            body.addShape(new CANNON.Plane());
            body.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
            world.addBody(body);
        }

        function createRamps(mat) {
            // רמפה לקפיצות
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(10, 2, 10), new THREE.MeshStandardMaterial({color:'red'}));
            mesh.position.set(20, 1, 20); mesh.rotation.x = -0.2; mesh.receiveShadow = true;
            scene.add(mesh);

            const body = new CANNON.Body({ mass: 0, material: mat });
            body.addShape(new CANNON.Box(new CANNON.Vec3(5, 1, 5)));
            body.position.set(20, 1, 20);
            body.quaternion.setFromEuler(-0.2, 0, 0);
            world.addBody(body);
        }

        function createPlayer() {
            // גוף פיזיקלי לשחקן
            playerBody = new CANNON.Body({ mass: 60, fixedRotation: true });
            playerBody.addShape(new CANNON.Sphere(1)); // פשוט יותר
            playerBody.position.set(0, 5, 0);
            playerBody.linearDamping = 0.9;
            world.addBody(playerBody);
        }

        function createCar(wheelMat) {
            // גוף הרכב
            chassisBody = new CANNON.Body({ mass: 150 });
            chassisBody.addShape(new CANNON.Box(new CANNON.Vec3(1, 0.5, 2)));
            chassisBody.position.set(10, 4, 10);
            chassisBody.angularDamping = 0.5;

            // מראה הרכב
            carMesh = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({ color: 0x00aaff }));
            carMesh.castShadow = true;
            scene.add(carMesh);

            // הגדרת הרכב
            vehicle = new CANNON.RaycastVehicle({
                chassisBody: chassisBody,
                indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
            });

            const options = {
                radius: 0.5, directionLocal: new CANNON.Vec3(0, -1, 0),
                suspensionStiffness: 30, suspensionRestLength: 0.3,
                frictionSlip: 1.4, dampingRelaxation: 2.3, dampingCompression: 4.4,
                maxSuspensionForce: 100000, rollInfluence: 0.01,
                axleLocal: new CANNON.Vec3(-1, 0, 0),
                chassisConnectionPointLocal: new CANNON.Vec3(1, 1, 0),
                maxSuspensionTravel: 0.3, useCustomSlidingRotationalSpeed: true,
                customSlidingRotationalSpeed: -30
            };

            vehicle.addWheel({...options, chassisConnectionPointLocal: new CANNON.Vec3(1, -0.5, 1.2)});
            vehicle.addWheel({...options, chassisConnectionPointLocal: new CANNON.Vec3(-1, -0.5, 1.2)});
            vehicle.addWheel({...options, chassisConnectionPointLocal: new CANNON.Vec3(1, -0.5, -1.2)});
            vehicle.addWheel({...options, chassisConnectionPointLocal: new CANNON.Vec3(-1, -0.5, -1.2)});

            vehicle.addToWorld(world);

            // גלגלים ויזואליים
            vehicle.wheelInfos.forEach(() => {
                const w = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.4, 20), new THREE.MeshStandardMaterial({color: 0x222}));
                w.rotation.z = Math.PI/2;
                w.castShadow = true;
                scene.add(w);
                wheelMeshes.push(w);
            });
        }

        function spawnEnemy() {
            // אויב (קובייה אדומה)
            const x = (Math.random() - 0.5) * 80;
            const z = (Math.random() - 0.5) * 80;
            
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0xff0000}));
            mesh.position.set(x, 1, z);
            mesh.castShadow = true;
            scene.add(mesh);

            const body = new CANNON.Body({ mass: 50, fixedRotation: true });
            body.addShape(new CANNON.Box(new CANNON.Vec3(0.5, 1, 0.5)));
            body.position.set(x, 1, z);
            body.linearDamping = 0.5;
            world.addBody(body);

            enemies.push({ mesh, body, health: 3 });
            document.getElementById('enemy-count').innerText = enemies.length;
        }

        function onShoot() {
            if (gameState !== 'WALKING' || !controls.isLocked) return;
            
            // אפקט רתיעה
            camera.rotation.x += 0.02;

            // בדיקת פגיעה (Raycast)
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(scene.children);

            for (let i = 0; i < intersects.length; i++) {
                const obj = intersects[i].object;
                
                // בדיקה אם פגענו באויב
                const enemyIndex = enemies.findIndex(e => e.mesh === obj);
                if (enemyIndex !== -1) {
                    const enemy = enemies[enemyIndex];
                    enemy.health--;
                    
                    // אפקט פגיעה (שינוי צבע רגעי)
                    obj.material.color.setHex(0xffffff);
                    setTimeout(() => obj.material.color.setHex(0xff0000), 100);

                    if (enemy.health <= 0) {
                        // הריגת אויב
                        scene.remove(enemy.mesh);
                        world.removeBody(enemy.body);
                        enemies.splice(enemyIndex, 1);
                        score += 100;
                        document.getElementById('score').innerText = score;
                        document.getElementById('enemy-count').innerText = enemies.length;
                        
                        // יצירת אויב חדש
                        setTimeout(spawnEnemy, 2000);
                    }
                    break; // פוגעים רק באויב אחד
                }
            }
        }

        function handleKeyLogic() {
            // כניסה/יציאה מרכב (E)
            if (keys.e) {
                keys.e = false; // מניעת לחיצה כפולה
                const dist = playerBody.position.distanceTo(chassisBody.position);
                
                if (gameState === 'WALKING' && dist < 5) {
                    gameState = 'DRIVING';
                    // מעלים את השחקן
                    playerBody.position.set(0, -10, 0);
                    playerBody.velocity.set(0,0,0);
                } else if (gameState === 'DRIVING') {
                    gameState = 'WALKING';
                    // ממקם את השחקן ליד הרכב
                    playerBody.position.copy(chassisBody.position);
                    playerBody.position.x += 3;
                    playerBody.position.y += 2;
                    playerBody.velocity.set(0,0,0);
                    // מאפס תנועת רכב
                    vehicle.applyEngineForce(0, 2); vehicle.applyEngineForce(0, 3);
                    vehicle.setSteeringValue(0, 0); vehicle.setSteeringValue(0, 1);
                }
            }
        }

        function updatePlayerMovement() {
            const speed = 10;
            // כיוון המצלמה
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            direction.y = 0; direction.normalize();

            const right = new THREE.Vector3();
            right.crossVectors(camera.up, direction).normalize(); // שינוי סדר ה-cross

            const velocity = new THREE.Vector3();
            if (keys.w) velocity.add(direction);
            if (keys.s) velocity.sub(direction);
            if (keys.a) velocity.add(right);
            if (keys.d) velocity.sub(right);

            if (velocity.lengthSq() > 0) velocity.normalize().multiplyScalar(speed);
            
            playerBody.velocity.x = velocity.x;
            playerBody.velocity.z = velocity.z;

            // עדכון מיקום המצלמה
            camera.position.copy(playerBody.position);
            camera.position.y += 1.6; // גובה עיניים
        }

        function updateCarMovement() {
            const force = keys.w ? 1500 : (keys.s ? -1000 : 0);
            const steer = keys.a ? 0.5 : (keys.d ? -0.5 : 0);
            
            vehicle.applyEngineForce(force, 2);
            vehicle.applyEngineForce(force, 3);
            vehicle.setSteeringValue(steer, 0);
            vehicle.setSteeringValue(steer, 1);

            // מצלמה עוקבת
            const relativeOffset = new THREE.Vector3(0, 5, -10);
            const cameraOffset = relativeOffset.applyMatrix4(carMesh.matrixWorld);
            camera.position.lerp(cameraOffset, 0.1);
            camera.lookAt(carMesh.position);
        }

        function updateEnemies() {
            const targetPos = gameState === 'WALKING' ? playerBody.position : chassisBody.position;

            enemies.forEach(e => {
                // תנועה לעבר השחקן
                const dir = new THREE.Vector3().subVectors(targetPos, e.body.position);
                dir.y = 0; dir.normalize();
                
                const speed = 3;
                e.body.velocity.x = dir.x * speed;
                e.body.velocity.z = dir.z * speed;
                
                // עדכון ויזואלי
                e.mesh.position.copy(e.body.position);
                e.mesh.quaternion.copy(e.body.quaternion); // אם רוצים שיתהפכו

                // נזק לשחקן
                const dist = e.body.position.distanceTo(targetPos);
                if (dist < 1.5) {
                    playerHealth -= 0.5;
                    document.getElementById('health-fill').style.width = playerHealth + '%';
                    if(playerHealth <= 0) {
                        alert("GAME OVER - RELOAD TO RESTART");
                        playerHealth = 100;
                    }
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = 1 / 60;
            world.step(dt);

            handleKeyLogic();

            if (gameState === 'WALKING') {
                updatePlayerMovement();
                // Crosshair visible
                document.getElementById('crosshair').style.display = 'block';
            } else {
                updateCarMovement();
                // Crosshair hidden
                document.getElementById('crosshair').style.display = 'none';
                
                // סנכרון רכב
                carMesh.position.copy(chassisBody.position);
                carMesh.quaternion.copy(chassisBody.quaternion);
                for(let i=0; i<vehicle.wheelInfos.length; i++) {
                    vehicle.updateWheelTransform(i);
                    wheelMeshes[i].position.copy(vehicle.wheelInfos[i].worldTransform.position);
                    wheelMeshes[i].quaternion.copy(vehicle.wheelInfos[i].worldTransform.quaternion);
                }
            }

            updateEnemies();
            renderer.render(scene, camera);
        }

        function onKey(e, down) {
            const k = e.key.toLowerCase();
            if (k in keys) keys[k] = down;
            if (e.code === 'Space') keys.space = down;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
